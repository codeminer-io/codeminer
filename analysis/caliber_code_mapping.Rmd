---
title: "Misc: UKB codings"
author: "Alasdair Warwick"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, results='hide'}
library(dplyr)
library(tidyr)
library(purrr)
library(readr)
library(configr)
library(ukbwranglr)
library(dm)
library(reactable)

# Constants
config <- read.config("config.ini")

# Load data
con <- DBI::dbConnect(RSQLite::SQLite(), dbname = config$PATHS$UKB_DB)
ukbdb <- dm::dm_from_src(con)
```

# Overview

Notes on expanding the CALIBER codelists to include Read 3 and ICD9.

# Mapping Read 2 to Read 3

## Introduction of duplicate codes

Example, code `E2273` (Read 2) is categorised as `Diagnosis of erectile dysfunction`. After mapping to Read 3, this appears as both `Diagnosis of erectile dysfunction` and `Possible diagnosis of erectile dysfunction`:

```{r}
ukbdb$caliber_codes %>% 
  filter(category %in% c("Diagnosis of erectile dysfunction",
                         "Possible diagnosis of erectile dysfunction")) %>% 
  collect() %>% 
  reactable(filterable = TRUE,
            resizable = TRUE,
            sortable = TRUE,
            showPageSizeOptions = TRUE,
            pageSizeOptions = c(5, 10, 30),
            defaultPageSize = 5)
```

This is because both Read 2 codes `Eu522` (categorised as `Possible diagnosis of erectile dysfunction`) and `E2273` (categorised as `Diagnosis of erectile dysfunction`) map to Read 3 `E2273`:

```{r}
ukbdb$read_v2_read_ctv3 %>% 
  filter(READV2_CODE == "Eu522") %>% 
  collect() %>% 
  reactable(filterable = TRUE,
            resizable = TRUE,
            sortable = TRUE,
            showPageSizeOptions = TRUE)
```

```{r}
ukbdb$read_v2_read_ctv3 %>%
  filter(READV2_CODE == "E2273") %>% 
  collect() %>% 
  reactable(filterable = TRUE,
            resizable = TRUE,
            sortable = TRUE)
```

