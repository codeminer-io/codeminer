---
title: "Read 3 to ICD-10 mapping"
author: "A Warwick and CY Ung"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    toc: false
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r global-options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(reactable)
library(readxl)
library(crosstalk)
library(targets)
library(codemapper)
library(flextable)

all_lkps_maps <- tar_read(all_lkps_maps_raw) %>% 
  purrr::map(codemapper:::rm_footer_rows_all_lkps_maps_df) %>%
  purrr::map(~ tibble::rowid_to_column(.data = .x,
                                       var = ".rowid"))

read_ctv3_icd10 <- all_lkps_maps$read_ctv3_icd10
icd10_lkp <- all_lkps_maps$icd10_lkp
```

```{r}
# utility functions
append_read_icd10_descriptions <- function(df,
                                            read_type = "read3") {
  match.arg(read_type,
            c("read2", "read3"))
  
  # get read and icd10 descriptions
  read_df <- df$read_code %>%
    lookup_codes(code_type = read_type, 
                 unrecognised_codes = "warning") %>%
    select(read_code = code,
           description_read3 = description)
  
  icd10_df <- df$icd10_code %>%
    lookup_codes(code_type = "icd10",
                 unrecognised_codes = "warning") %>%
    select(icd10_code = code,
           description_icd10 = description)
  
  # append descriptions
  list(df,
       read_df,
       icd10_df) %>%
    reduce(full_join) %>%
    select(contains("read"),
           contains("icd10"),
           everything())
}
```

# Key points

-   Dagger/asterisk ICD10 codes have 'D'/'A' appended respectively in the `read_ctv3_icd10` mapping table. These characters need removing to obtain the actual ICD10 codes that appear in the `icd10_lkp` table (`ALT_CODE` format) and UK Biobank data.
-   The nature of each code mapping is categorised under `mapping_status` and `refine_flag`. The `map_codes` function in `codemapper` filters by default for only mappings categorised as `mapping_status` 'E', 'G' or 'D', with `refine_flag` 'C' or 'P'. See [UK Biobank resource 592](https://biobank.ndph.ox.ac.uk/showcase/refer.cgi?id=592) for descriptions of these categories.

# Unrecognised ICD10 codes

```{r echo=FALSE}
# all read 3 codes appear in lookup table `read_ctv3_lkp`
unrecognised_read3_codes <- subset(read_ctv3_icd10$read_code,
       !read_ctv3_icd10$read_code %in% all_lkps_maps$read_ctv3_lkp$read_code)

assertthat::are_equal(length(unrecognised_read3_codes),
                      0)
```

All Read 3 codes in the `read_ctv3_icd10` mapping table are present in the `read_ctv3_lkp` lookup table.

```{r}
# identify unrecognised ICD10 codes
unrecognised_icd10_codes <- subset(read_ctv3_icd10$icd10_code,
       !read_ctv3_icd10$icd10_code %in% icd10_lkp$ALT_CODE) %>% 
  unique()
```

There are `r length(unrecognised_icd10_codes)` ICD10 codes in the `read_ctv3_icd10` mapping table that are *not* present in the `icd10_lkp` table (`ALT_CODE` format).

```{r echo=FALSE}
# do these all end in 'A' or 'D'? (i.e. 'asterisk' or 'dagger')
assertthat::are_equal(length(unrecognised_icd10_codes),
                      (read_ctv3_icd10 %>% 
                        filter(str_detect(icd10_code,
                                          pattern = "[A|D]$")) %>% 
                        pull(icd10_code) %>% 
                        unique() %>% 
                        length()))
```

These are all either 'asterisk' or 'dagger' codes, which have been appended with 'A' or 'D' respectively.

```{r echo=FALSE}
# remove 'D'/'A' appendices from dagger/asterisk ICD10 codes
read_ctv3_icd10_icd10_codes_modified <- read_ctv3_icd10 %>% 
  codemapper:::reformat_read_ctv3_icd10() %>% 
  pull(icd10_code) %>% 
  unique()

# see if any 'unrecognised' ICD10 codes remain
unrecognised_icd10_codes <- subset(read_ctv3_icd10_icd10_codes_modified,
       !read_ctv3_icd10_icd10_codes_modified %in% all_lkps_maps$icd10_lkp$ALT_CODE)

assertthat::are_equal(length(unrecognised_icd10_codes),
                      0)
```

After removing 'A' or 'D' from the ICD10 codes in mapping table `read_ctv3_icd10`, all ICD10 codes are also present in lookup table `icd10_lkp`.

# Mapping status and refine flag

The Read 3 to ICD10 mapping table has a number of columns with additional information:

```{r}
read_ctv3_icd10 %>% 
  head() %>% 
  select(-.rowid) %>% 
  knitr::kable(caption = "First few rows of the Read 3 to ICD10 mapping table")
```

These are described by UK Biobank [resource 592](https://biobank.ndph.ox.ac.uk/ukb/refer.cgi?id=592). The following tables show how `refine_flag` status varies by `mapping_status`. Mappings labelled with `mapping_status` 'E', 'D' and 'G' have the lowest proportion labelled with `refine_flag` 'M' (i.e. it is mandatory to check mappings labelled with `refine_flag` 'M' against the default)

**Counts:**

```{r}
refine_flag_by_mapping_status <- read_ctv3_icd10 %>% 
  distinct(mapping_status) %>% 
  filter(!is.na(mapping_status)) %>% 
  pull(mapping_status) %>% 
  set_names() %>% 
  map(~ {
    read_ctv3_icd10 %>% 
        filter(mapping_status == .x) %>% 
        group_by(refine_flag) %>% 
      summarise(n_unique_read3 = length(unique(read_code)))
    }) %>% 
  bind_rows(.id = "mapping_status") %>% 
  mutate(refine_flag = paste0("refine_flag_", refine_flag)) %>% 
  pivot_wider(names_from = refine_flag,
              values_from = n_unique_read3) %>% 
  mutate(Total_unique_read3 = rowSums(across(refine_flag_C:refine_flag_P)))

knitr::kable(refine_flag_by_mapping_status)
```

**Percentages:**

```{r}
refine_flag_by_mapping_status_pct <- refine_flag_by_mapping_status %>% 
  mutate(across(refine_flag_C:refine_flag_P,
                ~ round(.x / Total_unique_read3 * 100, digits = 3)))

knitr::kable(refine_flag_by_mapping_status_pct)
```

Mappings are categorised under the following `refine_flag` labels:

| `refine_flag` | Description                                  |
|---------------|----------------------------------------------|
| `C`           | Completely refined                           |
| `M`           | Mandatory to refine further                  |
| `P`           | Possible but not mandatory to refine further |

The `refine_flag` denotes whether or not the target code is sufficiently detailed to be acceptable. 3-character ICD codes are usually not acceptable, for example. Covers addition of 4th and 5th digit extensions in ICD, 4th character in OPCS-4.

```{r}
# get all possible combinations of `mapping_status`, `refine_flag` and
# `add_code_flag`
mapping_metadata_vars <- c("mapping_status",
  "refine_flag",
  "add_code_flag")

mapping_metadata_vars_combinations <- mapping_metadata_vars %>% 
  set_names() %>% 
  
  # get unique values for each variable
  map(~ read_ctv3_icd10 %>% 
        filter(!is.na(.data[[.x]])) %>% 
        pull(.data[[.x]]) %>% 
               unique()) %>% 
  
  # generate all possible combinations
  crossing(!!!.) %>% 
  
  # perform filtering join for only combinations that are actually present in
  # mapping table
  semi_join(read_ctv3_icd10,
            by = mapping_metadata_vars)

# convert this to a named list (where names describe the combination)
mapping_metadata_vars_combinations_list <- mapping_metadata_vars_combinations %>% 
  unite(col = "combination_label",
        everything(),
        remove = FALSE) %>% 
  mutate(combination_label = paste0("mapping_status/refine_flag/add_code_flag: ",
                                    combination_label))

mapping_metadata_vars_combinations_list <-
  split(
    mapping_metadata_vars_combinations_list,
    mapping_metadata_vars_combinations_list$combination_label
  ) %>%
  map(~ select(.x, -combination_label))
```

Here are some example codes for each refine flag

```{r}
# df of example mappings
mapping_metadata_vars_combinations_list_example_codes <-
  mapping_metadata_vars_combinations_list %>%
  map( ~ right_join(.x,
                    read_ctv3_icd10,
                    by = mapping_metadata_vars) %>%
         head(1)) %>%
  bind_rows() %>%
  pull(read_code)

mapping_metadata_vars_combinations_list_examples <-
  read_ctv3_icd10 %>%
  filter(read_code %in% mapping_metadata_vars_combinations_list_example_codes) %>%
  codemapper:::reformat_read_ctv3_icd10() %>%
  select(-.rowid) %>%
  append_read_icd10_descriptions() %>%
  bind_rows()

# crosstalk reactable table
mapping_metadata_vars_combinations_list_examples_crosstalk <-
  SharedData$new(mapping_metadata_vars_combinations_list_examples)

bscols(
  widths = c(3, 9),
  list(
    crosstalk::filter_select(
      "read_code",
      "Read code",
      mapping_metadata_vars_combinations_list_examples_crosstalk,
      ~ read_code
    ),
    crosstalk::filter_checkbox(
      "mapping_status",
      "Mapping status",
      mapping_metadata_vars_combinations_list_examples_crosstalk,
      ~ mapping_status
    ),
    crosstalk::filter_checkbox(
      "refine_flag",
      "Refine flag",
      mapping_metadata_vars_combinations_list_examples_crosstalk,
      ~ refine_flag
    ),
    crosstalk::filter_checkbox(
      "add_code_flag",
      "Add code flag",
      mapping_metadata_vars_combinations_list_examples_crosstalk,
      ~ add_code_flag
    )
  ),
  reactable(
    mapping_metadata_vars_combinations_list_examples_crosstalk,
    filterable = TRUE,
    searchable = TRUE,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 25, 50, 100),
    defaultPageSize = 5,
    resizable = TRUE,
    paginationType = 'jump'
  )
)
```

# Examples of non-specific Read 3 to sex-specific ICD10 code mappings

The Read 3 code `XaIP9` maps 'sebaceous cyst' to various ICD10 codes, including some which are sex-specific. A similar issue arises for Read 3 `M262.`

```{r}
# df of example mappings
non_specific_read3_to_sex_specific_icd10_examples <-
  read_ctv3_icd10 %>%
  filter(read_code %in% c('XaIP9', 'M262.')) %>%
  codemapper:::reformat_read_ctv3_icd10() %>%
  select(-.rowid) %>%
  append_read_icd10_descriptions()

# crosstalk reactable table
non_specific_read3_to_sex_specific_icd10_examples_crosstalk <-
  SharedData$new(non_specific_read3_to_sex_specific_icd10_examples)

bscols(
  widths = c(3, 9),
  list(
    crosstalk::filter_checkbox(
      "read_code",
      "Read code",
      non_specific_read3_to_sex_specific_icd10_examples_crosstalk,
      ~ read_code
    ),
    crosstalk::filter_checkbox(
      "mapping_status",
      "Mapping status",
      non_specific_read3_to_sex_specific_icd10_examples_crosstalk,
      ~ mapping_status
    ),
    crosstalk::filter_checkbox(
      "refine_flag",
      "Refine flag",
      non_specific_read3_to_sex_specific_icd10_examples_crosstalk,
      ~ refine_flag
    ),
    crosstalk::filter_checkbox(
      "add_code_flag",
      "Add code flag",
      non_specific_read3_to_sex_specific_icd10_examples_crosstalk,
      ~ add_code_flag
    )
  ),
  reactable(
    non_specific_read3_to_sex_specific_icd10_examples_crosstalk,
    filterable = TRUE,
    searchable = TRUE,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 25, 50, 100),
    defaultPageSize = 5,
    resizable = TRUE,
    paginationType = 'jump'
  )
)
```

# Example: type 2 diabetes

The description for Read 3 code 'C10..' is 'Diabetes mellitus'. This is an example of an unspecific Read 3 code that can potentially map to multiple specific ICD10 codes. Note that the default mapping (flagged as 'D' under `mapping_status`) is the most appropriate.

```{r}
read_ctv3_icd10 %>%
  filter(read_code == 'C10..') %>%
  codemapper:::reformat_read_ctv3_icd10() %>%
  select(-.rowid) %>%
  append_read_icd10_descriptions() %>% 
  select(read_code:add_code_flag,
         -icd10_dagger_asterisk) %>% 
  flextable()
```

Compare also with the Read 2 to ICD10 mapping, which does not label mappings as 'default'/'alternative'/'requires checking' but simply maps to all ICD10 codes 'E10-E14':

```{r}
all_lkps_maps$read_v2_icd10 %>%
  filter(read_code == 'C10..') %>%
  codemapper:::reformat_read_v2_icd10(icd10_lkp = all_lkps_maps$icd10_lkp) %>%
  select(-.rowid) %>%
  append_read_icd10_descriptions(read_type = "read2") %>% 
  select(-icd10_dagger_asterisk) %>% 
  flextable()
```
