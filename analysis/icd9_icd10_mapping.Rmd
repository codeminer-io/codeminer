---
title: "ICD9 to ICD10 mapping"
author: "A Warwick and CY Ung"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    toc: false
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r global-options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(reactable)
library(readxl)
library(crosstalk)
library(targets)
library(codemapper)
library(flextable)

all_lkps_maps <- tar_read(all_lkps_maps_raw) %>% 
  purrr::map(codemapper:::rm_footer_rows_all_lkps_maps_df) %>%
  purrr::map(~ tibble::rowid_to_column(.data = .x,
                                       var = ".rowid"))

icd9_icd10_raw <- all_lkps_maps$icd9_icd10
icd9_icd10 <- icd9_icd10_raw %>% 
  codemapper:::reformat_icd9_icd10()
```

# Key points

- While this mapping table is for ICD9 to ICD10, it is possible to map in either direction.

# Unmappable codes

There are a number of rows with missing values for either `DESCRIPTION_ICD9` or `DESCRIPTION_ICD10`, indicating that these codes have no ICD9/ICD10 equivalent:

```{r}
icd9_icd10_raw %>% 
  summarise(across(contains("_"),
                   list(N_missing = ~ sum(is.na(.x))))) %>% 
  knitr::kable()
```

These are labelled 'UNDEF' under `ICD9` and `ICD10`. Some examples[^1]:

[^1]: Note that ICD9 '0030' and ICD10 'A020' look like they could be mapped to each other.

```{r}
icd9_icd10_raw %>% 
  mutate(ICD_missing = case_when(
    is.na(DESCRIPTION_ICD9) ~ "icd9",
    is.na(DESCRIPTION_ICD10) ~ "icd10"
  )) %>% 
  filter(!is.na(ICD_missing)) %>% 
  group_by(ICD_missing) %>% 
  slice(1:3) %>% 
  ungroup() %>% 
  select(-.rowid,
         -ICD_missing) %>% 
  knitr::kable()
```

# One-to-many mappings

```{r}
n_icd9_to_many_icd10 <- icd9_icd10 %>% 
  filter(!is.na(ICD9)) %>% 
  count(ICD9) %>% 
  filter(n > 1) %>% 
  nrow()

n_icd10_to_many_icd9 <- icd9_icd10 %>% 
  filter(!is.na(ICD10)) %>% 
  count(ICD10) %>% 
  filter(n > 1) %>% 
  nrow()
```

One to many mappings occur in both directions. There are `r n_icd9_to_many_icd10` ICD9 and `r n_icd10_to_many_icd9` ICD10 codes that map to multiple ICD10 and ICD9 codes respectively.
