---
title: "Read 2 to ICD-10 mapping"
author: "A Warwick and CY Ung"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    toc: false
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r global-options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(reactable)
library(readxl)
library(crosstalk)
library(targets)
library(codemapper)
library(flextable)

tar_load(all_lkps_maps_raw)
read_v2_icd10 <- all_lkps_maps_raw$read_v2_icd10
```

```{r}
# utility functions
append_read2_icd10_descriptions <- function(df) {
  # get read2 and icd10 descriptions
  read2_df <- df$read_code %>%
    lookup_codes(code_type = "read2", 
                 unrecognised_codes = "warning") %>%
    select(read_code = code,
           description_read2 = description)
  
  icd10_df <- df$icd10_code %>%
    lookup_codes(code_type = "icd10",
                 unrecognised_codes = "warning") %>%
    select(icd10_code = code,
           description_icd10 = description)
  
  # append descriptions
  list(df,
       read2_df,
       icd10_df) %>%
    reduce(full_join) %>%
    select(contains("read"),
           contains("icd10"),
           everything())
}
```

# Key points

-   

# Unrecognised ICD10 codes

```{r}
# only the footer note (which appears under `read_code` in the raw `read_v2_icd10`
# mapping table) is not present in the `read_v2_lkp` lookup table)
unrecognised_read2_codes <- subset(read_v2_icd10$read_code,
       !read_v2_icd10$read_code %in% all_lkps_maps_raw$read_v2_lkp$read_code)

assertthat::are_equal(
  unrecognised_read2_codes,
  c(
    "Contains information from NHS Digital, licenced under the current version of the Open Government Licence available at www.nationalarchives.gov.uk/doc/open-government-licence/open-government-licence.htm",
    "ICD-10 codes, terms and text used by permission of WHO, from: International Statistical Classification of Diseases and Related Health Problems, Tenth Revision (ICD-10). Vols 1-3. Geneva, World Health Organization, 1992-2016."
  )
)
```

All Read 2 codes in the `read_v2_icd10` mapping table are present in the `read_v2_lkp` lookup table.

```{r}
# identify unrecognised ICD10 codes
unrecognised_icd10_codes <- subset(read_v2_icd10$icd10_code,
       !read_v2_icd10$icd10_code %in% all_lkps_maps_raw$icd10_lkp$ALT_CODE) %>% 
  unique()
```

There are `r length(unrecognised_icd10_codes)` ICD10 codes in the `read_v2_icd10` mapping table that are *not* present in the `icd10_lkp` table (`ALT_CODE` format). These are flagged by values in column `icd10_code_def`.

# Column `icd10_code_def`

Column `icd10_code_def` signifies, for example, whether or not the Read 2 code matches to a single ICD-10 code, if the ICD-10 code is a parent code that links to several child codes, if the ICD-10 code is asterisk or dagger code, a dagger-asterisk combination, etc.

Below are some example codes for each value in `icd10_code_def`:

```{r}
read_v2_icd10 %>%
  filter(!is.na(icd10_code_def)) %>%
  mutate(
    icd10_contains_dash = ifelse(str_detect(icd10_code,
                                        "-"),
                             yes = "dash",
                             no = NA_character_),
    icd10_contains_comma = ifelse(str_detect(icd10_code,
                                         ","),
                              yes = "comma",
                              no = NA_character_),
    icd10_contains_space = ifelse(str_detect(icd10_code,
                                         "\\s"),
                              yes = "space",
                              no = NA_character_),
    icd10_contains_plus = ifelse(str_detect(icd10_code,
                                        "\\+"),
                             yes = "plus",
                             no = NA_character_),
    icd10_contains_da_ending = ifelse(str_detect(icd10_code,
                                        "[D|A]$"),
                             yes = "DAending",
                             no = NA_character_)
  ) %>% 
  unite(col = "icd10_pattern_dash_comma_space_plus", 
        starts_with("icd10_contains_"), 
        sep = "_", 
        remove = TRUE, 
        na.rm = TRUE) %>% 
  group_by(icd10_code_def,
           icd10_pattern_dash_comma_space_plus) %>%
  slice(1L) %>%
  ungroup() %>% 
  append_read2_icd10_descriptions() %>% 
  arrange(description_icd10) %>% 
  select(icd10_code_def,
         icd10_pattern_dash_comma_space_plus,
         everything()) %>% 
  flextable::as_grouped_data("icd10_code_def") %>% 
  flextable()
```

The values in `icd10_code_def` may therefore be interpreted as follows (**TODO - look for official metadata document**):

| `icd10_code_def` | Description          |
|------------------|----------------------|
| 1                | One-to-one mapping   |
| 2                | One-to-many mapping, |
| 3                |                      |
| 5                |                      |
| 7                |                      |
| 8                |                      |
| 15               |                      |

# TODO

Ranges:

```{r}
read_v2_icd10 %>% 
  filter(str_detect(icd10_code,
                    "-")) %>% 
  distinct(icd10_code) %>% 
  # check for 5 digit ALT_CODE codes
  reactable(filterable = TRUE)
```

An example, "I00X-I99X ":

```{r}
read_v2_icd10 %>% 
  filter(icd10_code == "I00X-I99X") %>% 
  append_read2_icd10_descriptions()
```

Another example,
