---
title: "Read 2 to ICD10 mapping"
author: "A Warwick and CY Ung"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    toc: false
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r global-options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(reactable)
library(readxl)
library(crosstalk)
library(targets)
library(codemapper)
library(flextable)

all_lkps_maps <- tar_read(all_lkps_maps_raw) %>% 
  purrr::map(codemapper:::rm_footer_rows_all_lkps_maps_df) %>%
  purrr::map(~ tibble::rowid_to_column(.data = .x,
                                       var = ".rowid"))

read_v2_icd10 <- all_lkps_maps$read_v2_icd10
icd10_lkp <- all_lkps_maps$icd10_lkp
```

```{r}
# utility functions
append_read_icd10_descriptions <- function(df,
                                            read_type = "read2") {
  match.arg(read_type,
            c("read2", "read3"))
  
  # get read and icd10 descriptions
  read_df <- df$read_code %>%
    lookup_codes(code_type = read_type, 
                 unrecognised_codes = "warning") %>%
    select(read_code = code,
           description_read3 = description)
  
  icd10_df <- df$icd10_code %>%
    lookup_codes(code_type = "icd10",
                 unrecognised_codes = "warning") %>%
    select(icd10_code = code,
           description_icd10 = description)
  
  # append descriptions
  list(df,
       read_df,
       icd10_df) %>%
    reduce(full_join) %>%
    select(contains("read"),
           contains("icd10"),
           everything())
}
```

# Key points

-   Where a Read 2 code maps to multiple ICD10 codes, a range of ICD10 codes is presented in the `icd10_code` column. This needs reformatting (to allow programmatic mapping from Read 2 to ICD10) so that each ICD10 code appears on a separate row.

-   The following additional reformatting operations are also required to ensure that the ICD10 codes in this mapping table match the `ALT_CODE` format in lookup table `icd10_lkp`:

    -   Remove appended 'D'/'A' characters from dagger/asterisk ICD10 codes, and create a separate indicator column for these instead.

    -   Some undivided 3 character ICD10 codes appear inconsistently without an appended 'X'. For example, 'A64X' appears as 'A50-A64', 'A65X' appears as 'A65-A69', 'A70X' as 'A70-A74', 'A89X' as 'A80-A89' and 'A99X' as 'A92-A99'. The 'X' is re-appended to these codes during reformatting to match the `ALT_CODE` format in lookup table `icd10_lkp`.

    -   ICD10 code "C836" ("Diffuse non-Hodgkin's lymphoma - Undifferentiated (diffuse)") has been removed from ICD10 and does not exist in the `icd10_lkp` table. It is therefore also removed from the reformatted `read_v2_icd10` mapping table.

-   It is often appropriate to map a single Read 2 code to multiple ICD10 codes, where more than one ICD10 code is required to define a single specific Read 2 cod (see examples below). However, it may not be desirable to map a single Read 2 code with a non-specific description to multiple specific ICD10 codes. For example, the Read 2 code for 'Diabetes mellitus', 'C10..', is mapped to ICD10 codes 'E10-E14', which include both type 1 and type 2 diabetes as well as all their potential complications (e.g. renal and ophthalmic complications). The `map_codes` function in `codemapper` excludes this category of mappings (flagged as `icd10_code_def` '2' in the `read_v2_icd10` mapping table) by default.

# Unrecognised ICD10 codes

```{r echo=FALSE}
# all read 2 codes appear in lookup table `read_v2_lkp`
unrecognised_read2_codes <- subset(read_v2_icd10$read_code,
       !read_v2_icd10$read_code %in% all_lkps_maps$read_v2_lkp$read_code)

assertthat::are_equal(length(unrecognised_read2_codes),
                      0)
```

All Read 2 codes in the `read_v2_icd10` mapping table are present in the `read_v2_lkp` lookup table.

```{r}
# identify unrecognised ICD10 codes
unrecognised_icd10_codes <- subset(read_v2_icd10$icd10_code,
       !read_v2_icd10$icd10_code %in% all_lkps_maps$icd10_lkp$ALT_CODE) %>% 
  unique()
```

There are `r length(unrecognised_icd10_codes)` ICD10 codes in the `read_v2_icd10` mapping table that are *not* present in the `icd10_lkp` table (`ALT_CODE` format). These are mostly flagged by values in column `icd10_code_def`, with two exceptions:

1.  ICD10 code 'C836' has been removed from ICD10 and does not appear in the lookup `icd10_lkp`table.
2.  Several undivided 3 character ICD10 codes appear inconsistently without an appended 'X' in the `read_v2_icd10` mapping table.

Some examples, 'C836' and 'A64' (the latter should appear as 'A64X'):

```{r}
read_v2_icd10 %>% 
  filter(str_detect(icd10_code,
                    pattern = "A64|C836")) %>% 
  append_read_icd10_descriptions() %>% 
  select(-.rowid) %>% 
  flextable()
```

# Mapping types: `icd10_code_def`

Column `icd10_code_def` signifies, for example, whether or not the Read 2 code matches to a single ICD-10 code, if the ICD-10 code is a parent code that links to several child codes, if the ICD-10 code is asterisk or dagger code, a dagger-asterisk combination, etc.

Below are some example codes for each value in `icd10_code_def`:

```{r}
read_v2_icd10 %>%
  filter(!is.na(icd10_code_def)) %>%
  mutate(
    icd10_contains_dash = ifelse(str_detect(icd10_code,
                                        "-"),
                             yes = "dash",
                             no = NA_character_),
    icd10_contains_comma = ifelse(str_detect(icd10_code,
                                         ","),
                              yes = "comma",
                              no = NA_character_),
    icd10_contains_space = ifelse(str_detect(icd10_code,
                                         "\\s"),
                              yes = "space",
                              no = NA_character_),
    icd10_contains_plus = ifelse(str_detect(icd10_code,
                                        "\\+"),
                             yes = "plus",
                             no = NA_character_),
    icd10_contains_da_ending = ifelse(str_detect(icd10_code,
                                        "[D|A]$"),
                             yes = "DAending",
                             no = NA_character_)
  ) %>% 
  unite(col = "icd10_pattern", 
        starts_with("icd10_contains_"), 
        sep = "_", 
        remove = TRUE, 
        na.rm = TRUE) %>% 
  group_by(icd10_code_def,
           icd10_pattern) %>%
  slice(1L) %>%
  ungroup() %>% 
  append_read_icd10_descriptions() %>% 
  arrange(description_icd10) %>% 
  select(icd10_code_def,
         icd10_pattern,
         everything()) %>% 
  select(-.rowid) %>% 
  flextable::as_grouped_data("icd10_code_def") %>% 
  flextable() %>% 
  suppressWarnings()
```

Mappings categorised as `icd10_code_def` '1', '5' or '8' are one-to-one, whereas the other categories are one-to-many. Read codes in category '2' have non-specific descriptions and map to multiple specific ICD10 codes, which may be conflicting. The examples above are re-shown below with ICD10 code descriptions appended.

```{r}
read_v2_icd10 %>%
  filter(!is.na(icd10_code_def)) %>%
  mutate(
    icd10_contains_dash = ifelse(str_detect(icd10_code,
                                        "-"),
                             yes = "dash",
                             no = NA_character_),
    icd10_contains_comma = ifelse(str_detect(icd10_code,
                                         ","),
                              yes = "comma",
                              no = NA_character_),
    icd10_contains_space = ifelse(str_detect(icd10_code,
                                         "\\s"),
                              yes = "space",
                              no = NA_character_),
    icd10_contains_plus = ifelse(str_detect(icd10_code,
                                        "\\+"),
                             yes = "plus",
                             no = NA_character_),
    icd10_contains_da_ending = ifelse(str_detect(icd10_code,
                                        "[D|A]$"),
                             yes = "DAending",
                             no = NA_character_)
  ) %>% 
  unite(col = "icd10_pattern", 
        starts_with("icd10_contains_"), 
        sep = "_", 
        remove = TRUE, 
        na.rm = TRUE) %>% 
  group_by(icd10_code_def,
           icd10_pattern) %>%
  slice(1L) %>%
  ungroup() %>% 
  codemapper:::reformat_read_v2_icd10(icd10_lkp = all_lkps_maps$icd10_lkp) %>% 
  append_read_icd10_descriptions() %>% 
  arrange(description_icd10) %>% 
  select(icd10_code_def,
         icd10_pattern,
         everything()) %>% 
  select(-.rowid) %>% 
  reactable(filterable = TRUE,
            searchable = TRUE,
            showPageSizeOptions = TRUE,
            pageSizeOptions = c(10, 25, 50, 10),
            groupBy = "icd10_code_def")
```
