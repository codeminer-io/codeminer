---
title: "ICD-10 lookup table"
author: "A Warwick and CY Ung"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r global-options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE)
```

```{r}
library(tidyverse)
library(reactable)
library(readxl)
library(crosstalk)
library(targets)
library(codemapper)

tar_load(all_lkps_maps_raw)
```

# Overview

## codemapper tldr

- remove x(?)

# `ICD10_CODE` and `ALT-CODE` formats

ICD-10 codes are recorded in 2 formats: `ICD10_CODE` and `ALT-CODE`. UK Biobank [resource 592](https://biobank.ndph.ox.ac.uk/ukb/refer.cgi?id=592) states:

```
- CODE = ICD10 code
- ALT-CODE = This form strips the decimal point from the code and appends the filler X where the 3 character category is undivided. 
```

Other differences:

- MODIFIER_5: number added to ALT_CODE. Note M45.X does not have M45X equivalent (only M45X0-9), but S27.5 does have S275 equivalent

How does codemapper deal with 'X' (cf mapping sheets)

# TODO

```
- USAGE = Dagger / Asterisk indication
- USAGE_UK = Dagger / Asterisk indication
- DESCRIPTION = Longest preferred rubric
- MODIFIER_4 = 4th character modifier suffix
- MODIFIER_5 = 5th character modifier suffix
- QUALIFIERS = Dual classification (asterisk codes)
- GENDER_MASK = Gender mask: Identifies single sex conditions
- MIN_AGE = Minimum age that applies to this code
- MAX_AGE = Max age that applies to this code
- TREE_DESCRIPTION = This data field also contains descriptions that are functional in the context of the 3 character descriptions of their parent category, and are thus suitable for presentation where that context is available. For example:
C00 Malignant neoplasm of lip
C00.0 External upper lip
C00.1 External lower lip
C00.2 External lip, unspecified
```

```{r}
n_icd10_ends_x <- all_lkps_maps_raw$icd10_lkp %>% 
  filter(str_detect(ALT_CODE,
             ".X$")) %>% 
  nrow()
```

For `r n_icd10_ends_x` codes where the 3 character category is undivided, 'X' is appended in the `ALT_CODE` column. These are listed below:

```{r}
all_lkps_maps_raw$icd10_lkp %>% 
  filter(str_detect(ALT_CODE,
             ".X$")) %>% 
  reactable(filterable = TRUE,
            resizable = TRUE,
            searchable = TRUE,
            showPageSizeOptions = TRUE,
            pageSizeOptions = c(5, 10, 25, 50, 100, 200),
            paginationType = "jump",
            defaultPageSize = 5)
```

UK Biobank ICD-10 codes are recorded as per the `ALT_CODE` format, but does ***not*** append 'X' for these undivided 3 character category codes. 

The 'X' is therefore removed when looking up codes from the `icd_10` lookup sheet with argument `standardise_output = TRUE`. However, the 'X' is retained in the `icd10_lkp` sheet `ALT_CODE` column.

```{r}
# make sure that only 3 character ICD10 codes have an ALT_CODE ending with X
lengths_ICD10_CODE_ALT_ends_X <- all_lkps_maps_raw$icd10_lkp %>% 
  filter(str_detect(ALT_CODE,
             ".X$")) %>% 
  mutate(length_ICD10_CODE = str_length(ICD10_CODE)) %>% 
  pull(length_ICD10_CODE) %>% 
  unique()

assertthat::are_equal(lengths_ICD10_CODE_ALT_ends_X,
                      3)
```

```{r}
# check there are no icd10 codes with values in both the modifier 4 and 5 cols
n_icd10_codes_with_both_modifier_4_and_5 <- all_lkps_maps_raw$icd10_lkp %>% 
  filter(!is.na(MODIFIER_4) & !is.na(MODIFIER_5)) %>% 
  nrow()

assertthat::are_equal(n_icd10_codes_with_both_modifier_4_and_5, 0)
```

There are no ICD-10 codes with values for both `MODIFIER_4` AND `MODIFIER_5`.

Examples of codes with modifiers: `E10` and `I70.0`. For the latter, note that `I70.0` in `ICD10_CODE` format can have (i) no modifier (ii) 'without gangrene' modifier, or (iii) 'with gangrene' modifier. In `ALT_CODE` format, these appear as `I700`, `I7000` and `I7001` respectively.
