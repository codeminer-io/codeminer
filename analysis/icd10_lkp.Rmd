---
title: "ICD10 lookup table"
author: "A Warwick and CY Ung"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    toc: true
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r global-options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(reactable)
library(readxl)
library(crosstalk)
library(targets)
library(codemapper)

tar_load(all_lkps_maps_raw)
```

# Key points

- The ICD10 lookup table includes 2 formats: `ICD10_CODE` and `ALT_CODE`.
- In UK Biobank data, ICD10 codes are recorded in the `ALT_CODE` format (details below), *however an 'X' filler is not appended for codes where the 3 character category is undivided*. For example, the ICD10 code for Scarlet fever, `A38`, is recorded as `A38X` under `ALT_CODE` in the ICD10 lookup table, but recorded as `A38` in UK Biobank data.
- Some ICD10 codes have a one-to-many relationship from `ICD10_CODE` to `ALT_CODE` format. These codes have modifier descriptions under the `MODIFIER_5` column.

# ICD10 formats: `ICD10_CODE` and `ALT-CODE`

ICD10 codes are recorded in 2 formats in UK Biobank [resource 592](https://biobank.ndph.ox.ac.uk/ukb/refer.cgi?id=592) `ICD10_CODE` and `ALT_CODE`. The documentation states:

```
- ICD10_CODE = ICD10 code
- ALT_CODE = This form strips the decimal point from the code and appends the filler X where the 3 character category is undivided. 
```

> In UK Biobank data, ICD10 codes are recorded in the `ALT_CODE` format, *however an 'X' filler is not appended for codes where the 3 character category is undivided*. For example, the ICD10 code for Scarlet fever, `A38`, is recorded as `A38X` under `ALT_CODE` in the ICD10 lookup table, but recorded as `A38` in UK Biobank data:

```{r}
all_lkps_maps_raw$icd10_lkp %>% 
  filter(ICD10_CODE == "A38") %>% 
  select(ICD10_CODE:DESCRIPTION) %>% 
  knitr::kable()
```

A full list of undivided 3 character ICD10 codes is listed below:

```{r}
alt_code_ends_x <- all_lkps_maps_raw$icd10_lkp %>% 
  filter(str_detect(ALT_CODE,
             ".X$"))

alt_code_ends_x %>% 
  reactable(filterable = TRUE,
            resizable = TRUE,
            searchable = TRUE,
            showPageSizeOptions = TRUE,
            pageSizeOptions = c(5, 10, 25, 50, 100, 200),
            paginationType = "jump",
            defaultPageSize = 5)
```

While some ICD10 codes end with 'X' (e.g. `M45.X`), only undivided 3 character codes end with 'X' in `ALT_CODE` format:

```{r}
alt_code_ends_x %>% 
  mutate(ICD10_CODE_length = str_length(ICD10_CODE)) %>% 
  count(ICD10_CODE_length, 
        name = "n_ALT_CODEs_ending_with_X") %>% 
  knitr::kable()
```

There are also some other differences between the `ICD10_CODE` and `ALT_CODE` formats. In some cases, the same `ICD10_CODE` can have multiple descriptions that are differentiated by `MODIFIER_5`. For example, `S27.9` describes 'Injury unspecified intrathoracic organ', which can be further modified as follows:

```{r}
all_lkps_maps_raw$icd10_lkp %>% 
  filter(ICD10_CODE == "S27.9") %>% 
  select(ICD10_CODE:MODIFIER_5) %>% 
  knitr::kable()
```

Simply removing the '.' from `ICD10-CODE` will not capture all codes in these cases. Note also that in some cases, removing the '.' will not capture any codes used inn UK Biobank: 

```{r}
all_lkps_maps_raw$icd10_lkp %>% 
  filter(ICD10_CODE == "M45.X") %>% 
  select(ICD10_CODE:MODIFIER_5) %>% 
  knitr::kable()
```

The number of ICD10 codes with multiple descriptions is summarised by the following table. Note that these all have a `MODIFIER_5` description.

```{r}
n_non_unique_icd10_code_df <- all_lkps_maps_raw$icd10_lkp %>% 
  group_by(ICD10_CODE) %>% 
  summarise(n = n(),
         n_MODIFIER_5_not_na = sum(!is.na(MODIFIER_5)),
         n_MODIFIER_4_not_na = sum(!is.na(MODIFIER_4))) %>% 
  filter(n > 1) %>% 
  # select(ICD10_CODE:MODIFIER_5,
  #        contains("not_na")) %>% 
  arrange(n_MODIFIER_5_not_na)

list(
  n_non_unique_icd10_code = nrow(n_non_unique_icd10_code_df),
  n_with_modifier_5 = sum(n_non_unique_icd10_code_df$n_MODIFIER_5_not_na > 0),
  n_with_modifier_4 = sum(n_non_unique_icd10_code_df$n_MODIFIER_4_not_na > 0)
) %>% 
  as_tibble() %>% 
  knitr::kable()
```

ICD10 codes with `MODIFIER_4` descriptions are differentiated by their 4th digit. For example:

```{r}
all_lkps_maps_raw$icd10_lkp %>% 
  filter(str_detect(ICD10_CODE,
                    "^E10")) %>% 
  select(ICD10_CODE:MODIFIER_5) %>% 
  knitr::kable()
```

```{r include=FALSE}
# check there are no icd10 codes with values in both the modifier 4 and 5 cols
n_icd10_codes_with_both_modifier_4_and_5 <- all_lkps_maps_raw$icd10_lkp %>% 
  filter(!is.na(MODIFIER_4) & !is.na(MODIFIER_5)) %>% 
  nrow()

assertthat::are_equal(n_icd10_codes_with_both_modifier_4_and_5, 0)
```

Note, there are no ICD10 codes with values for both `MODIFIER_4` AND `MODIFIER_5`.

# Dagger/asterisk pairs

Some ICD10 codes use the 'dagger' and 'asterisk' system, where the primary code for the underlying disease is the 'dagger' and an optional additional code for the manifestation is marked with an 'asterisk'. See this [online article] for a fuller discussion

Dagger and asterisk codes are labelled `DAGGER` and `ASTERIS` For dagger coAsterisks codes are under `QUALIFIER` column

Below: `USAGE_UK == 1`. Here, `USAGE` is labelled `DAGGER` and the corresponding asterisk term(s) are shown under `QUALIFIERS`. Note that other dagger and asterisk code types have different `USAGE_UK` categories (see https://silo.tips/download/icd-10-4-th-edition-codes-and-titles-and-metadata-file-specification (update this link to direct link to ICD10 metadata file))

```{r}
# mapping df for ICD10_CODE:ALT_CODE format
icd10_alt_code_map <- all_lkps_maps_raw$icd10_lkp %>% 
  select(ICD10_CODE, ALT_CODE)

# df of dagger/asterisk pairs
icd10_dagger_asterisk_pairs <- all_lkps_maps_raw$icd10_lkp %>%
  filter(!is.na(QUALIFIERS)) 

# get descriptions for these codes
icd10_dagger_asterisk_descriptions <- icd10_dagger_asterisk_pairs %>%
  select(ICD10_CODE,
         QUALIFIERS) %>%
  map(reformat_icd10_codes) %>%
  map( ~ lookup_codes(codes = .x, code_type = "icd10")) %>% 
  bind_rows() %>% 
  left_join(icd10_alt_code_map,
            by = c("code" = "ALT_CODE")) %>% 
  select(description,
         ALT_CODE = code,
         ICD10_CODE)

# append descriptions to df of dagger/asterisk pairs
icd10_dagger_asterisk_pairs %>% 
  left_join(icd10_dagger_asterisk_descriptions %>% 
               select(-ICD10_CODE),
             by = c("ALT_CODE" = "ALT_CODE")) %>% 
  left_join(icd10_dagger_asterisk_descriptions %>% 
               select(-ALT_CODE),
             by = c("QUALIFIERS" = "ICD10_CODE"),   
             suffix = c("_ALT_CODE", "_QUALIFIERS")) %>% 
  select(ICD10_CODE,
         ALT_CODE,
         description_ALT_CODE,
         DESCRIPTION,
         USAGE,
         QUALIFIERS,
         description_QUALIFIERS,
         USAGE_UK) %>% 
  reactable(filterable = TRUE,
            searchable = TRUE,
            showPageSizeOptions = TRUE)
```

# Other details

More documentation from UK Biobank [resource 592](https://biobank.ndph.ox.ac.uk/ukb/refer.cgi?id=592):

```
- USAGE = Dagger / Asterisk indication
- USAGE_UK = Dagger / Asterisk indication
- DESCRIPTION = Longest preferred rubric
- MODIFIER_4 = 4th character modifier suffix
- MODIFIER_5 = 5th character modifier suffix
- QUALIFIERS = Dual classification (asterisk codes)
- GENDER_MASK = Gender mask: Identifies single sex conditions
- MIN_AGE = Minimum age that applies to this code
- MAX_AGE = Max age that applies to this code
- TREE_DESCRIPTION = This data field also contains descriptions that are functional in the context of the 3 character descriptions of their parent category, and are thus suitable for presentation where that context is available. For example:
C00 Malignant neoplasm of lip
C00.0 External upper lip
C00.1 External lower lip
C00.2 External lip, unspecified
```

## USAGE_UK {.tabset .tabset-pills}

Describes different combinations of `USAGE`, `MODIFIER_4`, `MODIFIER_5` and `QUALIFIERS`. See https://silo.tips/download/icd-10-4-th-edition-codes-and-titles-and-metadata-file-specification (TODO - replace with direct link to ICD10 metadata file) 

```{r results='asis'}
all_lkps_maps_raw$icd10_lkp %>%
  filter(!is.na(USAGE_UK)) %>%
  pull(USAGE_UK) %>%
  unique() %>%
  set_names() %>%
  map( ~ all_lkps_maps_raw$icd10_lkp %>%
         filter(USAGE_UK == .x) %>%
         head()) %>%
  iwalk( ~ {
    cat("### USAGE_UK ", .y, "\n\n")
    
    flextable::flextable(.x) %>%
      flextable::autofit() %>%
      flextable::flextable_to_rmd()
    
    cat("\n\n")
  })
```

## GENDER_MASK, MIN_AGE, MAX_AGE, TREE_DESCRIPTION (examples)

```{r}
all_lkps_maps_raw$icd10_lkp %>% 
  filter(!is.na(GENDER_MASK)) %>% 
  head() %>% 
  flextable::flextable()
```
